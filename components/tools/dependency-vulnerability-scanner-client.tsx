"use client";

import { useState, useCallback } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Progress } from "@/components/ui/progress";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { Upload, Shield, AlertTriangle, CheckCircle, XCircle, Download, FileText, Package } from "lucide-react";
import { LicenseIssue } from "@/types";

interface Vulnerability {
  id: string;
  package: string;
  version: string;
  cve: string;
  severity: "critical" | "high" | "medium" | "low";
  cvssScore: number;
  description: string;
  published: string;
  fixedVersion?: string;
  references: string[];
}

interface OutdatedPackage {
  name: string;
  currentVersion: string;
  latestVersion: string;
  type: "major" | "minor" | "patch";
  published: string;
}

interface ScanResult {
  totalDependencies: number;
  vulnerabilities: Vulnerability[];
  outdatedPackages: OutdatedPackage[];
  licenseIssues: LicenseIssue[];
  riskScore: number;
  scanTime: number;
}

const SCAN_OPTIONS = [
  { id: "vulnerabilities", label: "CVE Vulnerabilities", checked: true },
  { id: "outdated", label: "Outdated Packages", checked: true },
  { id: "licenses", label: "License Compliance", checked: true },
  { id: "transitive", label: "Transitive Dependencies", checked: true },
];

const PACKAGE_MANAGERS = [
  { id: "npm", label: "npm (package.json)", extensions: [".json"] },
  { id: "yarn", label: "Yarn (yarn.lock)", extensions: [".lock"] },
  { id: "pip", label: "Python (requirements.txt)", extensions: [".txt"] },
  { id: "maven", label: "Maven (pom.xml)", extensions: [".xml"] },
  { id: "gradle", label: "Gradle (build.gradle)", extensions: [".gradle", ".kts"] },
  { id: "composer", label: "PHP (composer.json)", extensions: [".json"] },
  { id: "gem", label: "Ruby (Gemfile)", extensions: [".lock", ""] },
];

export default function DependencyVulnerabilityScannerClient() {
  const [input, setInput] = useState("");
  const [files, setFiles] = useState<File[]>([]);
  const [scanResult, setScanResult] = useState<ScanResult | null>(null);
  const [isScanning, setIsScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [selectedOptions, setSelectedOptions] = useState(SCAN_OPTIONS);
  const [selectedPackageManager, setSelectedPackageManager] = useState("npm");
  const [error, setError] = useState<string | null>(null);

  const handleFileUpload = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFiles = Array.from(event.target.files || []);
    setFiles(selectedFiles);
    setError(null);
  }, []);

  const handleDragOver = useCallback((event: React.DragEvent) => {
    event.preventDefault();
  }, []);

  const handleDrop = useCallback((event: React.DragEvent) => {
    event.preventDefault();
    const droppedFiles = Array.from(event.dataTransfer.files);
    setFiles(droppedFiles);
    setError(null);
  }, []);

  const scanDependencies = async () => {
    if (!input.trim() && files.length === 0) {
      setError("Please provide dependency input or upload dependency files to scan.");
      return;
    }

    setIsScanning(true);
    setScanProgress(0);
    setError(null);

    try {
      const formData = new FormData();
      formData.append("input", input);
      formData.append("scanOptions", JSON.stringify(selectedOptions.filter(o => o.checked).map(o => o.id)));
      formData.append("packageManager", selectedPackageManager);

      files.forEach((file) => {
        formData.append("files", file);
      });

      // Simulate progress
      const progressInterval = setInterval(() => {
        setScanProgress(prev => Math.min(prev + 8, 90));
      }, 300);

      const response = await fetch("/api/tools/dependency-vulnerability-scanner", {
        method: "POST",
        body: formData,
      });

      clearInterval(progressInterval);

      if (!response.ok) {
        throw new Error("Failed to scan dependencies");
      }

      const result = await response.json();
      setScanResult(result);
      setScanProgress(100);
    } catch (err) {
      setError(err instanceof Error ? err.message : "An error occurred during scanning");
      setScanProgress(0);
    } finally {
      setIsScanning(false);
    }
  };

  const exportResults = () => {
    if (!scanResult) return;

    const dataStr = JSON.stringify(scanResult, null, 2);
    const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

    const exportFileDefaultName = "dependency-scan-results.json";

    const linkElement = document.createElement("a");
    linkElement.setAttribute("href", dataUri);
    linkElement.setAttribute("download", exportFileDefaultName);
    linkElement.click();
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "critical": return "bg-red-600";
      case "high": return "bg-red-500";
      case "medium": return "bg-orange-500";
      case "low": return "bg-yellow-500";
      default: return "bg-gray-500";
    }
  };

  const getRiskColor = (score: number) => {
    if (score >= 8) return "text-red-600";
    if (score >= 6) return "text-orange-600";
    if (score >= 4) return "text-yellow-600";
    return "text-green-600";
  };

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      {/* Input Section */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Upload className="w-5 h-5" />
            Dependency Input
          </CardTitle>
          <CardDescription>
            Upload dependency files or paste dependency lists to scan for vulnerabilities
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Tabs defaultValue="file" className="w-full">
            <TabsList className="grid w-full grid-cols-2">
              <TabsTrigger value="file">File Upload</TabsTrigger>
              <TabsTrigger value="manual">Manual Input</TabsTrigger>
            </TabsList>

            <TabsContent value="file" className="space-y-4">
              <div className="space-y-4">
                <div>
                  <Label htmlFor="package-manager">Package Manager</Label>
                  <select
                    id="package-manager"
                    value={selectedPackageManager}
                    onChange={(e) => setSelectedPackageManager(e.target.value)}
                    className="w-full mt-1 px-3 py-2 border border-input bg-background rounded-md"
                  >
                    {PACKAGE_MANAGERS.map((pm) => (
                      <option key={pm.id} value={pm.id}>
                        {pm.label}
                      </option>
                    ))}
                  </select>
                </div>

                <div
                  className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center hover:border-muted-foreground/50 transition-colors cursor-pointer"
                  onDragOver={handleDragOver}
                  onDrop={handleDrop}
                  onClick={() => document.getElementById("dependency-upload")?.click()}
                >
                  <Package className="w-12 h-12 mx-auto mb-4 text-muted-foreground" />
                  <p className="text-lg font-medium mb-2">Drop dependency files here or click to upload</p>
                  <p className="text-sm text-muted-foreground mb-4">
                    Supports package.json, requirements.txt, pom.xml, and other dependency files
                  </p>
                  <input
                    id="dependency-upload"
                    type="file"
                    multiple
                    className="hidden"
                    onChange={handleFileUpload}
                    accept=".json,.txt,.xml,.gradle,.kts,.lock"
                  />
                </div>

                {files.length > 0 && (
                  <div className="space-y-2">
                    <h4 className="font-medium">Selected Files:</h4>
                    <div className="max-h-32 overflow-y-auto space-y-1">
                      {files.map((file, index) => (
                        <div key={index} className="flex items-center gap-2 text-sm">
                          <FileText className="w-4 h-4" />
                          <span className="truncate">{file.name}</span>
                          <span className="text-muted-foreground">({(file.size / 1024).toFixed(1)} KB)</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </TabsContent>

            <TabsContent value="manual" className="space-y-4">
              <Textarea
                placeholder="Paste your dependencies here (one per line, format: package@version or package==version)..."
                value={input}
                onChange={(e) => setInput(e.target.value)}
                className="min-h-[200px] font-mono text-sm"
              />
              <p className="text-sm text-muted-foreground">
                Example: react@18.2.0, lodash@4.17.21, express==4.18.2
              </p>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>

      {/* Scan Options */}
      <Card>
        <CardHeader>
          <CardTitle>Scan Configuration</CardTitle>
          <CardDescription>
            Select what aspects of your dependencies to analyze
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {selectedOptions.map((option) => (
              <div key={option.id} className="flex items-center space-x-2">
                <Checkbox
                  id={option.id}
                  checked={option.checked}
                  onCheckedChange={(checked) => {
                    setSelectedOptions(prev =>
                      prev.map(o => o.id === option.id ? { ...o, checked: !!checked } : o)
                    );
                  }}
                />
                <Label htmlFor={option.id} className="text-sm font-medium">
                  {option.label}
                </Label>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Scan Button */}
      <div className="flex justify-center">
        <Button
          onClick={scanDependencies}
          disabled={isScanning || (!input.trim() && files.length === 0)}
          size="lg"
          className="px-8"
        >
          {isScanning ? (
            <>
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
              Scanning Dependencies...
            </>
          ) : (
            <>
              <Shield className="w-4 h-4 mr-2" />
              Scan Dependencies
            </>
          )}
        </Button>
      </div>

      {/* Progress Bar */}
      {isScanning && (
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>Analyzing dependencies...</span>
                <span>{scanProgress}%</span>
              </div>
              <Progress value={scanProgress} className="w-full" />
            </div>
          </CardContent>
        </Card>
      )}

      {/* Error Display */}
      {error && (
        <Alert variant="destructive">
          <XCircle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {/* Results Section */}
      {scanResult && (
        <div className="space-y-6">
          {/* Summary Card */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="flex items-center gap-2">
                    <CheckCircle className="w-5 h-5 text-green-500" />
                    Scan Summary
                  </CardTitle>
                  <CardDescription>
                    Analyzed {scanResult.totalDependencies} dependencies in {scanResult.scanTime}ms
                  </CardDescription>
                </div>
                <Button onClick={exportResults} variant="outline" size="sm">
                  <Download className="w-4 h-4 mr-2" />
                  Export Results
                </Button>
              </div>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="text-center">
                  <div className="text-2xl font-bold text-red-600">
                    {scanResult.vulnerabilities.filter(v => v.severity === "critical").length}
                  </div>
                  <div className="text-sm text-muted-foreground">Critical Vulnerabilities</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-orange-600">
                    {scanResult.outdatedPackages.filter(p => p.type === "major").length}
                  </div>
                  <div className="text-sm text-muted-foreground">Major Updates</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-yellow-600">
                    {scanResult.licenseIssues.filter(l => l.compatibility === "incompatible").length}
                  </div>
                  <div className="text-sm text-muted-foreground">License Issues</div>
                </div>
                <div className="text-center">
                  <div className={`text-2xl font-bold ${getRiskColor(scanResult.riskScore)}`}>
                    {scanResult.riskScore}/10
                  </div>
                  <div className="text-sm text-muted-foreground">Risk Score</div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Detailed Results */}
          <Tabs defaultValue="vulnerabilities" className="w-full">
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="vulnerabilities">
                Vulnerabilities ({scanResult.vulnerabilities.length})
              </TabsTrigger>
              <TabsTrigger value="outdated">
                Outdated ({scanResult.outdatedPackages.length})
              </TabsTrigger>
              <TabsTrigger value="licenses">
                Licenses ({scanResult.licenseIssues.length})
              </TabsTrigger>
            </TabsList>

            <TabsContent value="vulnerabilities" className="space-y-4">
              {scanResult.vulnerabilities.length === 0 ? (
                <Card>
                  <CardContent className="pt-6">
                    <div className="text-center py-8">
                      <CheckCircle className="w-16 h-16 mx-auto mb-4 text-green-500" />
                      <h3 className="text-lg font-semibold mb-2">No vulnerabilities found!</h3>
                      <p className="text-muted-foreground">
                        Your dependencies appear to be secure. Keep monitoring for new vulnerabilities.
                      </p>
                    </div>
                  </CardContent>
                </Card>
              ) : (
                <ScrollArea className="h-96">
                  <div className="space-y-4">
                    {scanResult.vulnerabilities.map((vuln) => (
                      <Card key={vuln.id}>
                        <CardContent className="pt-6">
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex items-center gap-2">
                              <Badge className={getSeverityColor(vuln.severity)}>
                                {vuln.severity.toUpperCase()}
                              </Badge>
                              <Badge variant="outline">{vuln.cve}</Badge>
                              <span className="text-sm text-muted-foreground">
                                CVSS: {vuln.cvssScore}
                              </span>
                            </div>
                            <span className="text-sm text-muted-foreground">
                              {new Date(vuln.published).toLocaleDateString()}
                            </span>
                          </div>

                          <div className="space-y-2">
                            <div>
                              <span className="font-medium">{vuln.package}@{vuln.version}</span>
                              {vuln.fixedVersion && (
                                <span className="text-sm text-muted-foreground ml-2">
                                  → {vuln.fixedVersion}
                                </span>
                              )}
                            </div>

                            <p className="text-sm text-muted-foreground">{vuln.description}</p>

                            {vuln.references.length > 0 && (
                              <div>
                                <Label className="text-sm font-medium">References:</Label>
                                <div className="mt-1 space-y-1">
                                  {vuln.references.slice(0, 3).map((ref, idx) => (
                                    <a
                                      key={idx}
                                      href={ref}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="text-sm text-blue-600 hover:underline block truncate"
                                    >
                                      {ref}
                                    </a>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </ScrollArea>
              )}
            </TabsContent>

            <TabsContent value="outdated" className="space-y-4">
              {scanResult.outdatedPackages.length === 0 ? (
                <Card>
                  <CardContent className="pt-6">
                    <div className="text-center py-8">
                      <CheckCircle className="w-16 h-16 mx-auto mb-4 text-green-500" />
                      <h3 className="text-lg font-semibold mb-2">All packages are up to date!</h3>
                      <p className="text-muted-foreground">
                        Your dependencies are using the latest available versions.
                      </p>
                    </div>
                  </CardContent>
                </Card>
              ) : (
                <ScrollArea className="h-96">
                  <div className="space-y-4">
                    {scanResult.outdatedPackages.map((pkg, index) => (
                      <Card key={index}>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium">{pkg.name}</span>
                            <Badge variant={pkg.type === "major" ? "destructive" : pkg.type === "minor" ? "default" : "secondary"}>
                              {pkg.type} update
                            </Badge>
                          </div>
                          <div className="text-sm text-muted-foreground">
                            {pkg.currentVersion} → {pkg.latestVersion}
                          </div>
                          <div className="text-xs text-muted-foreground mt-1">
                            Published: {new Date(pkg.published).toLocaleDateString()}
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </ScrollArea>
              )}
            </TabsContent>

            <TabsContent value="licenses" className="space-y-4">
              {scanResult.licenseIssues.length === 0 ? (
                <Card>
                  <CardContent className="pt-6">
                    <div className="text-center py-8">
                      <CheckCircle className="w-16 h-16 mx-auto mb-4 text-green-500" />
                      <h3 className="text-lg font-semibold mb-2">No license issues found!</h3>
                      <p className="text-muted-foreground">
                        All dependency licenses are compatible with your project.
                      </p>
                    </div>
                  </CardContent>
                </Card>
              ) : (
                <ScrollArea className="h-96">
                  <div className="space-y-4">
                    {scanResult.licenseIssues.map((issue, index) => (
                      <Card key={index}>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium">{issue.package}</span>
                            <Badge variant={issue.compatibility === "incompatible" ? "destructive" : "default"}>
                              {issue.compatibility}
                            </Badge>
                          </div>
                          <div className="text-sm text-muted-foreground mb-2">
                            License: {issue.license}
                          </div>
                          {issue.issues.length > 0 && (
                            <div>
                              <Label className="text-sm font-medium">Issues:</Label>
                              <ul className="mt-1 space-y-1">
                                {issue.issues.map((issueText, idx) => (
                                  <li key={idx} className="text-sm text-muted-foreground">
                                    • {issueText}
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </ScrollArea>
              )}
            </TabsContent>
          </Tabs>
        </div>
      )}
    </div>
  );
}